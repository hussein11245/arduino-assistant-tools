<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Arduino AI Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom styles for better code display and mobile responsiveness */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #eef2ff; /* Very light, inviting background */
        }
        .app-container {
            max-width: 95%; /* More fluid for small screens */
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 1024px) {
            .app-container {
                max-width: 5xl; /* Slightly wider for desktop viewing */
            }
        }
        pre {
            background-color: #272c47; /* Dark blue/slate for professional code look */
            color: #d8dee9;
            padding: 1rem;
            border-radius: 0.75rem; /* More rounded corners */
            overflow-x: auto;
            font-size: 0.9rem;
            line-height: 1.4;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* Enhanced Style for Markdown content */
        #tutorialOutput h3, #fullTutorialOutput h3, #explanationOutput h3 {
            @apply text-xl font-bold mt-6 mb-2 text-indigo-700 border-b-2 border-indigo-200 pb-1;
        }
        #tutorialOutput ul, #tutorialOutput ol, #fullTutorialOutput ul, #fullTutorialOutput ol, #explanationOutput ul, #explanationOutput ol {
            @apply list-inside ml-4 space-y-2 mb-4;
        }
        #tutorialOutput ul, #fullTutorialOutput ul, #explanationOutput ul {
            @apply list-disc text-gray-700;
        }
        #tutorialOutput ol, #fullTutorialOutput ol, #explanationOutput ol {
            @apply list-decimal text-gray-700;
        }
        #tutorialOutput p, #fullTutorialOutput p, #explanationOutput p {
            @apply mb-4 text-gray-700;
        }
        /* New: Stylish Button effect */
        .primary-btn {
            @apply px-6 py-3 bg-indigo-600 text-white font-bold rounded-full shadow-xl hover:bg-indigo-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-[1.02] active:scale-[0.98];
        }
        /* Re-added secondary button definition */
        .secondary-btn {
            @apply px-4 py-2 bg-purple-500 text-white font-medium rounded-lg shadow-md hover:bg-purple-600 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed;
        }

        /* Fade in effect for output */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <!-- Firebase Imports for Canvas Environment -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        window.firebaseInit = async () => {
            if (!firebaseConfig) {
                console.error("Firebase config not found.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and authenticated.");
                window.auth = auth;
                window.db = db;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        window.firebaseInit();
    </script>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="app-container bg-white shadow-2xl rounded-2xl p-6 md:p-12 transition-all duration-300 border-t-8 border-indigo-500">
        <header class="mb-8">
            <div class="flex items-center space-x-3">
                <svg class="w-10 h-10 text-indigo-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/><path d="M12 11h-1V9h1c.55 0 1 .45 1 1v1h1v1h-1c-.55 0-1 .45-1 1s.45 1 1 1h1v1h-1v-1c0-.55-.45-1-1-1s-1 .45-1 1v1h-1v-1h-1v1h-1v-1h1v-1h-1v-1h1v-1h-1v-1c0-.55.45-1 1-1zM15 15h1v1h-1v-1zM15 13h1v1h-1v-1zM15 11h1v1h-1v-1z"/></svg>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">
                    Your Fun Arduino Project Builder
                </h1>
            </div>
            <p class="text-gray-500 mt-2 text-base">
                Just tell me what you want to build (e.g., 'A simple night light'), and I'll give you the code and guide!
            </p>
        </header>

        <!-- Input Area -->
        <div class="mb-8 p-6 bg-indigo-50 rounded-xl border border-indigo-200 shadow-lg">
            <textarea id="projectPrompt" rows="3" class="w-full p-4 border-2 border-gray-300 rounded-xl focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 shadow-inner resize-none text-base" placeholder="e.g., 'A simple weather station using a BME280 sensor and OLED screen.'">LED circuit that toggles on or off every time a pushbutton is pressed.</textarea>
            <button id="generateBtn" onclick="generateProject()" class="w-full mt-4 primary-btn flex items-center justify-center">
                <span id="buttonText">Generate Project</span>
                <svg id="spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </button>
        </div>

        <!-- Output Display -->
        <div id="outputSection" class="space-y-10 hidden fade-in">
            <!-- Error Message Box -->
            <div id="errorBox" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert">
                <p id="errorMessage" class="font-bold"></p>
                <p class="text-sm mt-1">Please try refining your request or check your network connection.</p>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- Code Section -->
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold text-gray-800 mb-3 flex items-center">
                        <svg class="w-6 h-6 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        Arduino Code (Fixed & Ready)
                    </h2>
                    <div class="relative">
                        <pre><code id="codeContent"></code></pre>
                        <!-- Action Buttons: Copy and Explain -->
                        <div class="absolute top-2 right-2 flex space-x-2">
                            <button id="explainCodeBtn" onclick="explainCode()" class="secondary-btn flex items-center text-xs">
                                <span id="explainButtonText">âœ¨ Explain Code</span>
                                <svg id="explainSpinner" class="animate-spin -ml-1 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            </button>
                            <button id="copyCodeBtn" onclick="copyToClipboard('codeContent')" class="px-3 py-1 bg-gray-600 text-white text-xs font-medium rounded-md opacity-70 hover:opacity-100 transition duration-150">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Initial Placeholder / Tutorial Content -->
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold text-gray-800 mb-3 flex items-center">
                        <svg class="w-6 h-6 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10.5v11.25c0 .621.52.898 1.05.694l.974-.388c.24-.097.49-.146.74-.146H18.75c.621 0 .898.52.694 1.05l-.388.974c-.097.24-.146.49-.146.74v.006h.006a1.5 1.5 0 001.5-1.5V10.5M3 10.5a.75.75 0 01.75-.75h16.5a.75.75 0 01.75.75m-18 0a2.25 2.25 0 012.25 2.25v7.5A2.25 2.25 0 013 22.5M21 12h-18M6 12h12"></path></svg>
                        Quick Setup Guide
                    </h2>
                    <div id="tutorialOutput" class="text-gray-700 p-6 bg-indigo-50 border border-indigo-200 rounded-xl shadow-inner min-h-[150px]">
                        <p class="text-center py-4 text-gray-500">
                            The components and quick wiring steps will appear here.
                        </p>
                    </div>
                    <!-- TTS Feature Button -->
                    <div class="mt-4 flex flex-col items-center">
                        <button id="readAloudBtn" onclick="readTutorialAloud()" class="secondary-btn flex items-center justify-center mt-2">
                            <span id="ttsButtonText">ðŸ”Š Read Tutorial Aloud</span>
                            <svg id="ttsSpinner" class="animate-spin -ml-1 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                        <audio id="audioPlayback" controls class="mt-3 w-full max-w-xs rounded-full hidden"></audio>
                    </div>
                </div>
            </div>
            
            <!-- Code Explanation Section (New Feature) -->
            <div id="explanationSection" class="lg:col-span-2 hidden fade-in mt-8">
                 <h2 class="text-2xl font-bold text-gray-800 mb-3 flex items-center">
                    <svg class="w-6 h-6 inline-block mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Code Explanation (Powered by Gemini)
                </h2>
                <div id="explanationOutput" class="text-gray-700 p-6 bg-purple-50 rounded-xl border border-purple-200 shadow-inner">
                    <p class="text-center py-4 text-gray-500">Click the 'âœ¨ Explain Code' button to learn how the code works.</p>
                </div>
            </div>

            <!-- Full Tutorial and Sources Section (below grid for maximum width) -->
            <div class="lg:col-span-2 mt-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-3 flex items-center">
                    <svg class="w-6 h-6 inline-block mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.247m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.247"></path></svg>
                    Detailed Step-by-Step Tutorial
                </h2>
                <div id="fullTutorialOutput" class="text-gray-700 p-6 bg-white rounded-xl border border-gray-200 shadow-md">
                    <!-- The parsed Markdown content will be injected here -->
                </div>
            </div>

            <!-- Citations Section -->
            <div id="citationSection" class="mt-8 pt-4 border-t border-gray-100">
                <h3 class="text-lg font-semibold text-gray-600 mb-2">
                    <svg class="w-5 h-5 inline-block mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.102l1.102 1.102M13.828 10.172L21 17.344"></path></svg>
                    Sources (Grounding)
                </h3>
                <ul id="sourcesList" class="text-sm text-gray-500 list-disc pl-5 space-y-1">
                    <li>Sources for the generated content will appear here after generation.</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // API Configuration (API_KEY is supplied by the Canvas environment)
        const API_KEY = ""; // Leave as-is for runtime injection
        const TEXT_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL_NAME = "gemini-2.5-flash-preview-tts";
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL_NAME}:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL_NAME}:generateContent?key=${API_KEY}`;

        // DOM Elements
        const promptInput = document.getElementById('projectPrompt');
        const generateBtn = document.getElementById('generateBtn');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const outputSection = document.getElementById('outputSection');
        const codeContent = document.getElementById('codeContent');
        const tutorialOutput = document.getElementById('tutorialOutput'); // Snapshot view
        const fullTutorialOutput = document.getElementById('fullTutorialOutput'); // Full view
        const explanationSection = document.getElementById('explanationSection');
        const explanationOutput = document.getElementById('explanationOutput');
        const explainCodeBtn = document.getElementById('explainCodeBtn');
        const explainButtonText = document.getElementById('explainButtonText');
        const explainSpinner = document.getElementById('explainSpinner');
        const readAloudBtn = document.getElementById('readAloudBtn');
        const ttsButtonText = document.getElementById('ttsButtonText');
        const ttsSpinner = document.getElementById('ttsSpinner');
        const audioPlayback = document.getElementById('audioPlayback');
        const sourcesList = document.getElementById('sourcesList');
        const errorBox = document.getElementById('errorBox');
        const errorMessage = document.getElementById('errorMessage');
        const copyCodeBtn = document.getElementById('copyCodeBtn');

        // Internal variables for state
        let currentTutorialText = ''; // Stores the text for TTS

        // --- Utility Functions for TTS ---

        // Function to convert Base64 string to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Function to create WAV blob from PCM data
        function pcmToWav(pcm16, sampleRate = 16000) {
            const numChannels = 1;
            const bytesPerSample = 2; // Int16
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.byteLength;
            const fileSize = 36 + dataSize;

            const buffer = new ArrayBuffer(fileSize);
            const view = new DataView(buffer);

            // RIFF chunk
            view.setUint32(0, 0x52494646, false); // "RIFF"
            view.setUint32(4, fileSize - 8, true);
            view.setUint32(8, 0x57415645, false); // "WAVE"

            // FMT chunk
            view.setUint32(12, 0x666d7420, false); // "fmt "
            view.setUint32(16, 16, true);          // Sub-chunk size (16 for PCM)
            view.setUint16(20, 1, true);           // Audio format (1 for PCM)
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bytesPerSample * 8, true); // Bits per sample (16)

            // DATA chunk
            view.setUint32(36, 0x64617461, false); // "data"
            view.setUint32(40, dataSize, true);

            // Copy PCM data
            const pcmBytes = new Uint8Array(pcm16.buffer);
            let offset = 44;
            for (let i = 0; i < dataSize; i++, offset++) {
                view.setUint8(offset, pcmBytes[i]);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- General Utility Functions ---

        // Exponential backoff retry logic for API calls
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        const errorDetails = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status}. Details: ${errorDetails.substring(0, 100)}...`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function setLoading(isLoading) {
            generateBtn.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Generating Awesome Project...' : 'Generate Project';
            spinner.classList.toggle('hidden', !isLoading);
            errorBox.classList.add('hidden');
        }

        function setFeatureLoading(button, spinnerElement, buttonTextElement, isLoading, defaultText) {
            button.disabled = isLoading;
            buttonTextElement.textContent = isLoading ? 'Loading...' : defaultText;
            spinnerElement.classList.toggle('hidden', !isLoading);
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
            outputSection.classList.add('hidden');
            setLoading(false);
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const textToCopy = element.textContent;
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                // Success feedback
                const originalText = 'Copy';
                copyCodeBtn.textContent = 'Copied!';
                copyCodeBtn.classList.remove('bg-gray-600');
                copyCodeBtn.classList.add('bg-green-500');
                setTimeout(() => {
                    copyCodeBtn.textContent = originalText;
                    copyCodeBtn.classList.remove('bg-green-500');
                    copyCodeBtn.classList.add('bg-gray-600');
                }, 1500);
            } catch (err) {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please manually select the code.');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }
        window.copyToClipboard = copyToClipboard;

        // Simple custom alert function to replace window.alert
        function alert(message) {
            const alertBox = document.createElement('div');
            alertBox.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <h3 class="text-lg font-bold text-indigo-600 mb-3">Heads Up!</h3>
                        <p class="text-gray-700 mb-4">${message}</p>
                        <button onclick="this.parentNode.parentNode.remove()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-150">Got It</button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertBox);
        }
        window.alert = alert; // Expose custom alert globally

        // --- New Gemini Feature Implementations ---

        async function explainCode() {
            const code = codeContent.textContent.trim();
            if (!code) {
                alert("Please generate the project code first before requesting an explanation.");
                return;
            }

            explanationSection.classList.remove('hidden');
            explanationOutput.innerHTML = `<p class="text-center py-4 text-gray-500">Analyzing code structure...</p>`;
            setFeatureLoading(explainCodeBtn, explainSpinner, explainButtonText, true, 'Analyzing...');

            const systemPrompt = `You are a helpful Arduino code analysis bot. Analyze the provided Arduino code. Provide a clear, line-by-line explanation, focusing on the purpose of variables, the setup function, and the loop logic. Specifically, explain any hardware interaction techniques like debouncing or state machines. Format the explanation in Markdown.`;
            
            const userQuery = `Explain the following Arduino code:\n\n\`\`\`arduino\n${code}\n\`\`\``;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    explanationOutput.innerHTML = marked.parse(text);
                } else {
                    explanationOutput.innerHTML = `<p class="p-4 text-red-600">Could not generate explanation. Try again or check the console for details.</p>`;
                }

            } catch (error) {
                console.error("Code Explanation API Failed:", error);
                explanationOutput.innerHTML = `<p class="p-4 text-red-600">Error: Failed to fetch explanation (${error.message}).</p>`;
            } finally {
                setFeatureLoading(explainCodeBtn, explainSpinner, explainButtonText, false, 'âœ¨ Explain Code');
            }
        }
        window.explainCode = explainCode;

        async function readTutorialAloud() {
            if (!currentTutorialText) {
                alert("Please generate a project tutorial first before reading it aloud.");
                return;
            }

            // Clean up the text: remove markdown, image tags, and citations for clean speech generation
            let textToSpeak = currentTutorialText
                .replace(/#+ /g, '. ') // Replace headers with a period for a pause
                .replace(/[\*\_\`]/g, '') // Remove markdown emphasis characters
                .replace(/\/g, 'Check the wiring diagram for reference.') // Replace the image tag with spoken description
                .trim();
            
            // Only take the first 1000 characters to avoid hitting the TTS context limit
            textToSpeak = textToSpeak.substring(0, 1000);

            // Hide previous audio and set loading state
            audioPlayback.classList.add('hidden');
            audioPlayback.removeAttribute('src');
            setFeatureLoading(readAloudBtn, ttsSpinner, ttsButtonText, true, 'Generating Audio...');

            const payload = {
                contents: [{
                    parts: [{ text: `Read the following tutorial with an upbeat and informative tone:\n\n${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" } // Upbeat voice
                        }
                    }
                },
                model: TTS_MODEL_NAME
            };

            try {
                const response = await fetchWithRetry(TTS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    audioPlayback.src = audioUrl;
                    audioPlayback.classList.remove('hidden');
                    audioPlayback.play();
                } else {
                    throw new Error("Invalid or missing audio data from API response.");
                }

            } catch (error) {
                console.error("TTS API Call Failed:", error);
                alert(`Audio generation failed: ${error.message}.`);
            } finally {
                setFeatureLoading(readAloudBtn, ttsSpinner, ttsButtonText, false, 'ðŸ”Š Read Tutorial Aloud');
            }
        }
        window.readTutorialAloud = readTutorialAloud;

        // --- Main Generation Function ---

        async function generateProject() {
            const userQuery = promptInput.value.trim();
            if (!userQuery) {
                showError("Please enter a description for your Arduino project.");
                return;
            }

            setLoading(true);
            explanationSection.classList.add('hidden'); // Reset explanation view
            audioPlayback.classList.add('hidden'); // Reset audio player
            
            // System Instruction: Enforce structured output and include the image tag.
            const systemPrompt = `You are an expert Arduino Uno programmer and tutorial writer. Your tone should be encouraging and fun. Your task is to generate complete, runnable Arduino Uno code for the user's requested project, followed by a detailed, step-by-step tutorial. The entire response MUST adhere to this format strictly:
1. Start with the code block. Use markdown triple backticks and specify 'arduino' as the language. Ensure the code is robust and handles common hardware issues like button debouncing if applicable. For the 'LED circuit that toggles on or off every time a pushbutton is pressed' project, you MUST use debouncing logic and state variables for robust operation.
2. After the code block, provide the step-by-step tutorial in Markdown format (using headers and lists).
3. The tutorial must start with a '# Components Required' list and detailed '# Wiring Instructions' before the '# Software Steps'. 
4. **CRITICAL**: Include the tag  immediately after the "Wiring Instructions" section to provide a visual aid.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetchWithRetry(TEXT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    showError("The AI did not return valid content. It may have been blocked or the request was too complex.");
                    return;
                }

                const responseText = candidate.content.parts[0].text;
                
                // 1. Parse the generated text
                const codeMatch = responseText.match(/```arduino\n([\s\S]*?)\n```/);
                const code = codeMatch ? codeMatch[1].trim() : 'Error: Could not find Arduino code block. See tutorial for details.';
                const tutorialMarkdown = codeMatch ? responseText.substring(codeMatch.index + codeMatch[0].length).trim() : responseText;

                // 2. Display Code
                codeContent.textContent = code;

                // 3. Store and Display Tutorial
                currentTutorialText = tutorialMarkdown; // Store for TTS
                fullTutorialOutput.innerHTML = marked.parse(tutorialMarkdown);

                // 4. Create a shorter snippet for the snapshot view
                const componentsMatch = tutorialMarkdown.match(/# Components Required[\s\S]*?# Wiring Instructions/);
                let snapshotContent = componentsMatch ? componentsMatch[0] : tutorialMarkdown.split('\n').slice(0, 15).join('\n');
                
                snapshotContent = snapshotContent.replace(/# Wiring Instructions/, '## Wiring Instructions (See below for full details)');
                
                tutorialOutput.innerHTML = marked.parse(snapshotContent);

                // 5. Extract and display grounding sources
                sourcesList.innerHTML = '';
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                if (sources.length > 0) {
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-500 hover:underline transition duration-150">${source.title}</a>`;
                        sourcesList.appendChild(li);
                    });
                } else {
                    sourcesList.innerHTML = '<li>No external sources were explicitly used for grounding this response. The information is based on the model\'s training data.</li>';
                }

            } catch (error) {
                console.error("API Call Failed:", error);
                showError(`A critical error occurred: ${error.message}.`);
            } finally {
                setLoading(false);
                outputSection.classList.remove('hidden');
                outputSection.scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // Auto-run for the example project on load
        window.onload = function() {
            if (window.firebaseInit) {
                window.firebaseInit().then(() => {
                    generateProject();
                });
            } else {
                generateProject();
            }
        };
    </script>
</body>
</html>